{% extends "base.html" %}

{% block content %}
<div>
    <h4>
        <span>Train a Regression Model</span>
        <a href="{{url_for('index')}}">
            <svg id="home-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512">
                <!--! Font Awesome Pro 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. -->
                <path fill-opacity="80%"
                    d="M575.8 255.5C575.8 273.5 560.8 287.6 543.8 287.6H511.8L512.5 447.7C512.5 450.5 512.3 453.1 512 455.8V472C512 494.1 494.1 512 472 512H456C454.9 512 453.8 511.1 452.7 511.9C451.3 511.1 449.9 512 448.5 512H392C369.9 512 352 494.1 352 472V384C352 366.3 337.7 352 320 352H256C238.3 352 224 366.3 224 384V472C224 494.1 206.1 512 184 512H128.1C126.6 512 125.1 511.9 123.6 511.8C122.4 511.9 121.2 512 120 512H104C81.91 512 64 494.1 64 472V360C64 359.1 64.03 358.1 64.09 357.2V287.6H32.05C14.02 287.6 0 273.5 0 255.5C0 246.5 3.004 238.5 10.01 231.5L266.4 8.016C273.4 1.002 281.4 0 288.4 0C295.4 0 303.4 2.004 309.5 7.014L564.8 231.5C572.8 238.5 576.9 246.5 575.8 255.5L575.8 255.5z" />
            </svg>
        </a>
    </h4>

    {% if not args.csv_path %}
    <p>Select a file to be used for training data...</p>
    <div id="drop-zone" ondrop="dropHandler(event);" ondragover="dragOverHandler(event);" ondragleave="endDragOver();"
        ondragend="endDragOver();">
        <p class="text-center">
            Drag file here or
            <label>
                <input id="browse-file" type="file" accept=".csv" />
                <a href="" id="browse-link">browse</a>
            </label>
            <label class="text-dark text-sm font-italic text-center text-sm">
                (.csv)
            </label>
            <br /><br />
            <svg height="50" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                <!--! Font Awesome Pro 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. -->
                <path fill-opacity="80%"
                    d="M105.4 182.6c12.5 12.49 32.76 12.5 45.25 .001L224 109.3V352c0 17.67 14.33 32 32 32c17.67 0 32-14.33 32-32V109.3l73.38 73.38c12.49 12.49 32.75 12.49 45.25-.001c12.49-12.49 12.49-32.75 0-45.25l-128-128C272.4 3.125 264.2 0 256 0S239.6 3.125 233.4 9.375L105.4 137.4C92.88 149.9 92.88 170.1 105.4 182.6zM480 352h-160c0 35.35-28.65 64-64 64s-64-28.65-64-64H32c-17.67 0-32 14.33-32 32v96c0 17.67 14.33 32 32 32h448c17.67 0 32-14.33 32-32v-96C512 366.3 497.7 352 480 352zM432 456c-13.2 0-24-10.8-24-24c0-13.2 10.8-24 24-24s24 10.8 24 24C456 445.2 445.2 456 432 456z" />
            </svg>
        </p>
    </div>

    <p id="file-display" class="text-secondary">{{ args.csv_filename }}</p>
    {% endif %}

    <form action="/regression/linear/train" method="GET">

        <input id="csv-path" name="csv_path" value="{{ args.csv_path }}" type="hidden" />
        <input id="df-ref" name="df_ref" value="{{ args.df_ref }}" type="hidden" />

        <!--tmp for debugging-->
        <!-- <label for="csv-path-display" class="form-label mt-4">csv
            <small>(tmp for debugging)</small>
        </label>
        <input id="csv-path-display" name="csv_path_display" value="{{ args.csv_path }}" 
               disabled style="width: 100%"/> -->
        <!--tmp end-->
        <!--Basic Training options (supervised)-->
        <fieldset>
            <div class="form-group">

                <!--Result col option-->
                <label for="result-column" class="form-label mt-4 {{ 'hide-and-collapse' if args.csv_path else '' }}">
                    Result column
                </label>
                <select class="form-select {{ 'hide-and-collapse' if args.csv_path else '' }}" id="result-column"
                    name="result_column" required placeholder="Add file to see options...">
                    {% if args.result_column %}
                    <option value="{{ args.result_column }}" selected>{{ args.result_column }}</option>
                    {% endif %}
                </select>

                <!--Model selection-->
                <div>
                    <label for="regression-model">Model:</label>
                    <select id="regression-model" name="regression_model" required>
                        <option value="LinearRegression" {% if args.model_name=='LinearRegression' %} selected {% endif
                            %}>
                            Linear Regression
                        </option>
                        <option value="GradientBoostingRegressor" {% if args.model_name=='GradientBoostingRegressor' %}
                            selected {% endif %}>
                            Gradient Boosting Regression
                        </option>
                    </select>
                </div>

                <!--Test train split-->
                <div>
                    <label for="trn-split" class="form-label">Training split</label>
                    <input type="range" class="form-range" min="0" max="1" step="0.01" list="tickmarks" value={{
                        args.training_split }} id="trn-split" name="trn_split" required
                        style="width: 30%; padding-left: 5px;">
                    <datalist id="tickmarks">
                        {% for pct in range(0, 110, 10) %}
                        <option value="{{ pct/100 }}" label="{{ pct }}"></option>
                        {% endfor %}
                    </datalist>

                    <input type="text" disabled="" id="trn-pct-display" style="width: 50px; margin-left: 10px"
                        value="{{ '%0.0f'|format(args.training_split*100) ~ '%' }}" />

                    <!--TODO: tooltip explaining why to use i.e.
                              If you use the same file, split % and random seed, the same rows will
                              be allocated to each set, allowing for reproducible results.-->
                    <label for="trn-split-random-seed" class="form-label" style="padding-left: 10px">
                        Random Seed <small>(optional)</small>
                    </label>
                    <input type="number" id="trn-split-random-seed" name="trn_split_random_seed"
                        value="{{ args.random_seed }}" placeholder="For a reproducible split">

                    <br />
                    <small style="margin-left: 20px">
                        The proportion of the data to be used for training the model (the rest
                        will be held back to evaluate the trained model against).
                    </small>
                </div>
            </div>
        </fieldset>
        <fieldset>

            <!--Preprocessing-->
            <fieldset class="form-group">
                <legend class="mt-4">Preprocessing Options</legend>
                <div class="form-check">
                    <!--standardise option-->
                    <input class="form-check-input" type="checkbox" id="check-standardise" name="check_standardise"
                        {{ 'checked=""' if args.standardise else '' }}>
                    <label class="form-check-label" for="check-standardise">
                        Standardise 
                        <small>
                            (centre and scale data across columns to zero mean, unit variance)
                        </small>
                    </label>
                </div>
                <div class="form-check">
                    <!--normalise option-->
                    <input class="form-check-input" type="checkbox" id="check-normalise" name="check_normalise"
                        {{ 'checked=""' if args.normalise else '' }}>
                    <label class="form-check-label" for="check-normalise">
                        Normalise data per sample 
                        <small>
                            (sum to one, accounting for missing values)
                        </small>
                    </label>
                    <div class="text-warning">
                        <small>This should only be used
                            if it makes sense for the columns in each row to sum to one
                            (i.e. they can be seen as proportions of a whole).
                        </small>
                    </div>
                </div>
                <p>Option for missing values comming soon...</p>
            </fieldset>

            <button type="submit" class="btn btn-success">Train Model</button>
    </form>

    <div class="progress" id="progress" style="visibility: hidden;">
        <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar"
            id="progress-bar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
        </div>
    </div>

    <!--Hidden until error-->
    <div id="error-info" style="display: none">
        <p style="color:#FF0000" ;>
            <!--Erorr details below overwritten in js if we get more details in json resp-->
            <span id="error-details">An Error Occurred. Please consider sending the file to us for investigation.</span>
            <a href="mailto:{{support_email}}?subject=Error">
                <i class="fa fa-lg fa-solid fa-envelope"></i>
            </a>
        </p>
    </div>

    {% if evaluation %}

    <div class="row">

        <div class="col">
            <img class="plot" src="{{ evaluation.act_vs_pred_uri }}" 
                 alt="Plot of predicted vs actual values">
        </div>

        <div class="col">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th scope="col">Metrics</th>
                        <th scope="col"></th>
                    </tr>
                </thead>
                <tbody>
                {% for (desc, val) in evaluation.metrics %}
                    <tr>
                        <td>{{ desc }}</th>
                        <td style="text-align: right;">{{ '%0.2f'|format(val) }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

    </div>
    {% endif %}

    <!--tmp for debugging - model ref-->
    <!-- <div>
        <label for="model-ref" class="form-label">Trained model ref</label>
        <input type="text" id="model-ref" name="model_ref" value="{{ model_ref }}" 
               disabled="" style="width: 42%"/>
    </div> -->
</div>
{% endblock %}